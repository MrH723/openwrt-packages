<%#
 Copyright 2017-2018 Jo-Philipp Wich <jo@mein.io>
 Licensed to the public under the Apache License 2.0.
-%>

<%+header%>

<link rel="stylesheet" href="<%=resource%>/view/nlbw.css?v=git-19.365.69375-13f9718" />

<script type="text/javascript" src="<%=resource%>/nlbw.chart.min.js?v=git-19.365.69375-13f9718"></script>
<script type="text/javascript" src="<%=resource%>/view/nlbw.js?v=git-19.365.69375-13f9718"></script>

<h2 name="content"><%:Netlink Bandwidth Monitor%></h2>

<hr />

<div>
	<div class="cbi-section" data-tab="traffic" data-tab-title="<%:Traffic Distribution%>">
		<div class="head">

			<div class="kpi">
				<ul>
					<li><%_<big id="host-total">0</big> hosts%></li>
					<li><%_<big id="rx-total">0</big> download%></li>
					<li><%_<big id="tx-total">0</big> upload%></li>
					<li><%_<big id="conn-total">0</big> connections%></li>
				</ul>
			</div>
		</div>
		<div class="table" id="host-data">
			<div class="tr table-titles">
				<div class="th left hostname"><%:Host%></div>
				<div class="th right"><%:MAC%></div>
				<div class="th right"><%:Connections%></div>
				<div class="th right"><%:Download (Bytes)%></div>
				<div class="th right"><%:Download (Packets)%></div>
				<div class="th right"><%:Upload (Bytes)%></div>
				<div class="th right"><%:Upload (Packets)%></div>
			</div>
			<div class="tr placeholder">
				<div class="td">
					<em class="spinning"><%:Collecting data...%></em>
				</div>
			</div>
		</div>
	</div>

	<div class="cbi-section" data-tab="layer7" data-tab-title="<%:Application Protocols%>">
		<div class="head">

			<div class="kpi">
				<ul>
					<li><%_<big id="layer7-total">0</big> different application protocols%></li>
					<li><%_<big id="layer7-most-rx">0</big> cause the most download%></li>
					<li><%_<big id="layer7-most-tx">0</big> cause the most upload%></li>
					<li><%_<big id="layer7-most-conn">0</big> cause the most connections%></li>
				</ul>
			</div>
		</div>
		<div class="table" id="layer7-data">
			<div class="tr table-titles">
				<div class="th left"><%:Application%></div>
				<div class="th right"><%:Connections%></div>
				<div class="th right"><%:Download (Bytes)%></div>
				<div class="th right"><%:Download (Packets)%></div>
				<div class="th right"><%:Upload (Bytes)%></div>
				<div class="th right"><%:Upload (Packets)%></div>
			</div>
			<div class="tr placeholder">
				<div class="td">
					<em class="spinning"><%:Collecting data...%></em>
				</div>
			</div>
		</div>
	</div>

	<div class="cbi-section" data-tab="ipv6" data-tab-title="<%:IPv6%>">
		<div class="head">

			<div class="kpi">
				<ul>
					<li><%_<big id="ipv6-hosts">0%</big> IPv6 support rate among hosts%></li>
					<li><%_<big id="ipv6-share">0%</big> of the total traffic is IPv6%></li>
					<li><%_<big id="ipv6-rx">0B</big> total IPv6 download%></li>
					<li><%_<big id="ipv6-tx">0B</big> total IPv6 upload%></li>
				</ul>
			</div>
		</div>
		<div class="table" id="ipv6-data">
			<div class="tr table-titles">
				<div class="th left"><%:Host%></div>
				<div class="th right"><%:MAC%></div>
				<div class="th double right hide-xs"><%:Family%></div>
				<div class="th double right"><%:Download (Bytes)%></div>
				<div class="th double right"><%:Download (Packets)%></div>
				<div class="th double right"><%:Upload (Bytes)%></div>
				<div class="th double right"><%:Upload (Packets)%></div>
			</div>
			<div class="tr placeholder">
				<div class="td">
					<em class="spinning"><%:Collecting data...%></em>
				</div>
			</div>
		</div>
	</div>

</div>

<script type="text/javascript">//<![CDATA[
	var hostInfo = <%=luci.util.serialize_json(luci.sys.net.host_hints())%>;
	function pie(id, data)
	{return}
	function formatHostname(dns)
	{
		if (dns === undefined || dns === null || dns === '')
			return '-';

		dns = dns.split('.')[0];

		if (dns.length > 12)
			return '<span title="%q">%hâ€¦</span>'.format(dns, dns.substr(0, 12));

		return '%h'.format(dns);
	}
	var bakdataold;
	function fetchData(period)
	{
	  XHR.poll(2,L.url('admin/nlbw/data'), {
		period: period,
		group_by: 'family,mac,ip,layer7',
		order_by: '-rx_bytes,-tx_bytes'
	  }, function (xhr, res) {
		if (res !== null && typeof (res) === 'object' && typeof (res.columns) === 'object' && typeof (res.data) === 'object')
		trafficData = res;
		trafficData["data"].sort();
		bakdatanew = JSON.parse(JSON.stringify(trafficData["data"]));
		if (bakdataold){
			var j=0;
			var k=j;
			var ll=bakdataold.length;
			for (i=0,l=trafficData["data"].length; i<l ; i++){
				one=trafficData["data"][i];
				for (j=k;j<ll;j++){
					if (one[0]==bakdataold[j][0] && one[1]==bakdataold[j][1] && one[2]==bakdataold[j][2] && one[3]==bakdataold[j][3] && one[4]==bakdataold[j][4] ){
						one[5]=(one[5]-bakdataold[j][5])/2;
						one[6]=(one[6]-bakdataold[j][6])/2;
						one[7]=(one[7]-bakdataold[j][7])/2;
						one[8]=(one[8]-bakdataold[j][8])/2;
						one[9]=(one[9]-bakdataold[j][9])/2;
						k=j+1;
						break;
					}
				}
			}
		}
		bakdataold=bakdatanew;
		var addrs = query(null, [
		  'ip'
		], null);
		var ipAddrs = [
		];
		for (var i = 0; i < addrs.length; i++)
		if (ipAddrs.indexOf(addrs[i].ip) < 0)
		ipAddrs.push(addrs[i].ip);
		renderHostData();
		renderLayer7Data();
		renderIPv6Data();
		if (hostNames.length == 0){
		XHR.get(L.url('admin/nlbw/ptr', ipAddrs.join('/')), null, function (xhr, res) {
		  if (res !== null && typeof (res) === 'object')
		  hostNames = res;
		});}
	  });
	  XHR.poll(5,'<%=url([[admin]], [[status]], [[onliner]], [[setnlbw]])%>', null, function(xhr, res) {
	});
	}
	XHR.get(L.url('admin/nlbw/list'), null, function(xhr, res) {
		xhr.open('GET', 'https://raw.githubusercontent.com/jow-/oui-database/master/oui.json', true);
		xhr.onreadystatechange = function() {
			if (xhr.readyState === 4) {
				try { res = JSON.parse(xhr.responseText); }
				catch(e) { res = null; }

				if (res !== null && typeof(res) === 'object' && (res.length % 3) === 0)
					ouiData = res;

				fetchData('');
			}
		};
		xhr.send(null);
	});
	document.addEventListener('tooltip-open', function(ev) {
		renderHostDetail.call(ev.detail.target, ev.target);
	});

	if ('ontouchstart' in window) {
		document.addEventListener('touchstart', function(ev) {
			var tooltip = document.querySelector('.cbi-tooltip');
			if (tooltip === ev.target || tooltip.contains(ev.target))
				return;

			L.hideTooltip(ev);
		});
	}
//]]></script>

<%+footer%>
